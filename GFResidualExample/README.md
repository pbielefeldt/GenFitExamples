# GFResidualExample

## Overview

**GFResidualExample** demonstrates how to use [GenFit2](https://github.com/GenFit/GenFit) for track fitting and for analyzing *residuals*—differences between simulated "truth" positions and reconstructed positions—using a minimal, geometry-free setup.
This example can help understanding core concepts of GenFit2, including measurement handling, residual computation, and the statistical interpretation of fit results.

## Measurement Definition and Readout Geometry in GenFit2

In GenFit2, measurements are described by the [`AbsMeasurement`](https://github.com/GenFit/GenFit/blob/master/core/include/AbsMeasurement.h) interface, which represents the measured values (coordinates), their covariance, and (optionally) a reference back to the original detector hit.
Importantly, **GenFit2 does not require a predefined detector geometry** for defining measurement planes.
Instead, every measurement provides its own local measurement plane, which can be arbitrarily chosen.

**In this example:**
- For each simulated (Monte Carlo) point, a "measurement" is generated by smearing the true position with Gaussian noise (the same width for all coordinates, set by the `SMEAR` parameter).
- A measurement (and its associated plane) is created for each point, using the local coordinate system with two axes (`U` and `V`) in the plane perpendicular to the track direction.
- These planes and coordinate systems are completely independent of any physical detector geometry (e.g., wires, strips, pixels)—they are mathematical constructs, as allowed by GenFit2.

For more details on measurement definitions, see [AbsMeasurement.h](https://github.com/GenFit/GenFit/blob/master/core/include/AbsMeasurement.h) and the [GenFit README](https://github.com/GenFit/GenFit/blob/master/README.md).

## What Are Residuals?

In this context, a **residual** is the difference between the simulated ("Monte Carlo truth") position and the position predicted by the fit, projected onto the local measurement (readout) plane for each track.

- **Simulation:**
  Points are generated along a straight line.
  Gaussian noise with width `SMEAR` is added to each coordinate to mimic measurement uncertainty.
- **Fit:**
  GenFit2 reconstructs a straight track from the smeared points using its 5D track representation, but in this example the underlying truth is a straight line.
- **Residual:**
  For each measurement, the residual is calculated as the difference between the fitted track's intersection with the measurement plane and the intersection point of the "true" track (`intersectionTrackPlane`) with the plane, projected onto the plane's `U` and `V` axes.

This procedure is typical for performance, resolution, and alignment studies where the underlying geometry is either simple or intentionally abstracted away.

## Interpreting the Resulting Residual Distributions

Since each measurement plane is two-dimensional (`U` and `V`), the residuals are analyzed separately for each direction.
**This produces two 1D distributions**—one for each axis—rather than a single distribution of 2D distances.

- **Why not just one distribution?**
  The total "distance" between truth and fit in the plane would form a Rayleigh distribution, which is less intuitive and harder to interpret in terms of detector resolution or algorithm performance. In contrast, the projections onto `U` and `V` are expected to be Gaussian-shaped if the noise is Gaussian.
- **Expectations:**
  - Both `U` and `V` residual distributions should be centered near zero (unbiased reconstruction).
  - The width (standard deviation, σ) of both should be close to the `SMEAR` value used for the Gaussian noise, as this is applied equally to all coordinates.
  - The means and widths should be nearly identical for `U` and `V` due to the symmetric setup.

**Interpretation:**
- If you change `SMEAR`, you should see the width of both distributions change accordingly.
- Increasing `N_POINTS` (number of points per track) will not substantially change the residual width, but can improve fit stability.
- Increasing `N_RUNS` (number of tracks) increases the sample statistics, making the distributions smoother.

## Interpreting the Pull Distributions

In addition to residuals, this example can analyze **pull distributions**.
A *pull* is a normalized residual, defined as:

\[
\text{pull} = \frac{\text{fitted value} - \text{measured value}}{\text{estimated uncertainty from the fit}}
\]

- The pull quantifies how consistent the fit result is with the measurement, in units of the expected error.
- If the fit's uncertainty estimation is accurate, the pull distribution should be centered at zero with width one (Gaussian with σ ≈ 1).

Pulls are a standard tool for validating track fit quality and error estimation.

## Building GFResidualExample

### Prerequisites

- **ROOT 6** (https://root.cern): Usually available through your Linux distribution’s package manager (e.g., `sudo zypper install root6`), or install from [ROOT’s website](https://root.cern/install/).
- **GenFit2** (https://github.com/GenFit/GenFit): Must be cloned and compiled from source; follow the [GenFit2 build instructions](https://github.com/GenFit/GenFit).
- **CMake** (version 2.8+)
- **C++ compiler** (GCC or Clang recommended)

### Environment Setup

Set the following environment variables so the build system can find ROOT and GenFit2:

```sh
export ROOTSYS=/path/to/your/root/installation
export GENFIT2_DIR=/path/to/your/genfit2/installation
export LD_LIBRARY_PATH=$ROOTSYS/lib:$GENFIT2_DIR/lib:$LD_LIBRARY_PATH
export PATH=$ROOTSYS/bin:$GENFIT2_DIR/bin:$PATH
```

Adapt the paths to your installation.

### Building

1. Change to the `GFResidualExample` directory:
    ```sh
    cd GFResidualExample
    ```
2. Create and enter a build directory:
    ```sh
    mkdir build && cd build
    ```
3. Configure the project:
    ```sh
    cmake ..
    ```
4. Build:
    ```sh
    cmake --build .
    ```

An executable will be created in the build directory.

## Running the Example

After building, run the example with:

```sh
./GFResidualExample
```

(There may be optional arguments; check for a `--help` flag or see the code for details.)

The program generates tracks, fits them, calculates residuals, and writes output histograms to a ROOT file.

## Output

- A PNG file created by ROOT with the `U` and `V` residual distributions
- A PNG file with the pull distributions
- A ROOT file with all data

You should see two distributions (U and V) with Gaussian shapes, both with mean ≈ 0 and width ≈ `SMEAR`.
The pull distributions are expected to be a standard Gaussian curve.

## Using this Example for Your Own Analysis

- Start by modifying the simulation (e.g., use more complex track shapes, add multiple scattering, etc.).
- Change the measurement plane definitions to study different projections or test new ideas.
- Use the residual calculation as a basis for detector resolution or alignment studies in more realistic setups.
- Integrate actual detector geometry or real hit data if desired; GenFit2 is flexible enough to accommodate this.


## References

- [CDF Note 5776, Section 2.2](https://hep-physics.rockefeller.edu/luc/technical_reports/cdf5776_pulls.pdf)
- [GenFit2 Documentation](https://github.com/GenFit/GenFit)
- [ROOT Documentation](https://root.cern/manual/)
- [AbsMeasurement.h](https://github.com/GenFit/GenFit/blob/master/core/include/AbsMeasurement.h)
- Track fitting and residual analysis literature.

